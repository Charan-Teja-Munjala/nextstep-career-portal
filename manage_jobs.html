<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Jobs - NextStep Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #add-job-form {
            display: none;
            transition: all 0.3s ease-in-out;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <div class="hidden md:flex flex-col w-64 bg-white border-r">
            <div class="flex items-center justify-center h-16 border-b">
                <span class="text-2xl font-bold text-indigo-600">NextStep Hub</span>
            </div>
            <div class="flex flex-col flex-grow p-4">
                <nav class="flex-grow space-y-2">
                    <a href="organization_dashboard.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">
                        <i data-lucide="layout-dashboard"></i>
                        <span class="ml-3">Dashboard</span>
                    </a>
                    <a href="manage_jobs.html" class="flex items-center px-4 py-2 text-white bg-indigo-600 rounded-lg">
                        <i data-lucide="briefcase"></i>
                        <span class="ml-3">Manage Jobs</span>
                    </a>
                    <a href="manage_courses.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">
                        <i data-lucide="book-open"></i>
                        <span class="ml-3">Manage Courses</span>
                    </a>
                    <a href="organization_profile.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">
                        <i data-lucide="user"></i>
                        <span class="ml-3">Profile</span>
                    </a>
                </nav>
                <div class="mt-auto">
                     <a href="organization_logout.php" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg">
                         <i data-lucide="log-out"></i>
                         <span class="ml-3">Logout</span>
                     </a>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            <div class="flex items-center justify-between h-16 bg-white border-b px-4">
                 <div>
                     <h1 class="text-xl font-semibold text-gray-800">Manage Job Postings</h1>
                 </div>
                 <button id="add-job-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center">
                    <i data-lucide="plus" class="mr-2 h-5 w-5"></i> Add New Job
                 </button>
            </div>
            
            <main class="p-6 md:p-8">
                 <div id="main-message-container"></div>
                <!-- Add Job Form (hidden by default) -->
                <div id="add-job-form" class="mb-8 p-8 bg-white rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Post a New Job</h2>
                    <form id="new-job-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="jobTitle" class="block text-sm font-medium text-gray-700">Job Title</label>
                                <input type="text" id="jobTitle" name="jobTitle" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
                                <input type="text" id="location" name="location" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="job_type" class="block text-sm font-medium text-gray-700">Job Type</label>
                                <select id="job_type" name="job_type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option>Full-time</option>
                                    <option>Part-time</option>
                                    <option>Internship</option>
                                    <option>Contract</option>
                                </select>
                            </div>
                             <div>
                                <label for="experience_level" class="block text-sm font-medium text-gray-700">Experience Level</label>
                                <select id="experience_level" name="experience_level" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option>Entry-level</option>
                                    <option selected>Mid-level</option>
                                    <option>Senior</option>
                                    <option>Lead</option>
                                    <option>Manager</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="salary_range" class="block text-sm font-medium text-gray-700">Salary Range (Optional)</label>
                            <input type="text" id="salary_range" name="salary_range" placeholder="e.g., $80,000 - $100,000 per year" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700">Job Description</label>
                            <textarea id="description" name="description" rows="5" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div>
                            <label for="requirements" class="block text-sm font-medium text-gray-700">Requirements</label>
                            <textarea id="requirements" name="requirements" rows="5" placeholder="List each requirement on a new line..." required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="isRemote" name="isRemote" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="isRemote" class="ml-2 block text-sm text-gray-900">This is a remote position</label>
                        </div>
                        <div id="form-message" class="mt-4"></div>
                        <div class="mt-6 text-right">
                             <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 mr-2">Cancel</button>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Post Job</button>
                        </div>
                    </form>
                </div>

                <!-- Job Listings -->
                <div class="bg-white rounded-lg shadow-sm">
                    <div class="p-4 border-b">
                         <h2 class="text-xl font-bold text-gray-800">Your Current Job Postings</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Posted</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Applicants</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Edit Job Modal -->
    <div id="edit-job-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-full overflow-y-auto">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Edit Job Posting</h2>
            <form id="edit-job-form" class="space-y-6">
                <input type="hidden" id="editJobId" name="id">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="editJobTitle" class="block text-sm font-medium text-gray-700">Job Title</label>
                        <input type="text" id="editJobTitle" name="jobTitle" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="editLocation" class="block text-sm font-medium text-gray-700">Location</label>
                        <input type="text" id="editLocation" name="location" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit_job_type" class="block text-sm font-medium text-gray-700">Job Type</label>
                        <select id="edit_job_type" name="job_type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            <option>Full-time</option> <option>Part-time</option> <option>Internship</option> <option>Contract</option>
                        </select>
                    </div>
                     <div>
                        <label for="edit_experience_level" class="block text-sm font-medium text-gray-700">Experience Level</label>
                        <select id="edit_experience_level" name="experience_level" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                           <option>Entry-level</option> <option>Mid-level</option> <option>Senior</option> <option>Lead</option> <option>Manager</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="edit_salary_range" class="block text-sm font-medium text-gray-700">Salary Range (Optional)</label>
                    <input type="text" id="edit_salary_range" name="salary_range" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="editDescription" class="block text-sm font-medium text-gray-700">Job Description</label>
                    <textarea id="editDescription" name="description" rows="5" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                </div>
                <div>
                    <label for="edit_requirements" class="block text-sm font-medium text-gray-700">Requirements</label>
                    <textarea id="edit_requirements" name="requirements" rows="5" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="editIsRemote" name="isRemote" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    <label for="editIsRemote" class="ml-2 block text-sm text-gray-900">This is a remote position</label>
                </div>
                <div id="edit-form-message" class="mt-4"></div>
                <div class="mt-6 text-right">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 mr-2">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- View Applicants Modal -->
    <div id="view-applicants-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="view-applicants-title" class="text-xl font-semibold text-gray-800">Applicants</h3>
                <button class="text-gray-400 hover:text-gray-600 modal-close-btn"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="view-applicants-body" class="p-6 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    
    <script>
        lucide.createIcons();
        document.addEventListener('DOMContentLoaded', () => {
            const addJobForm = document.getElementById('add-job-form');
            const addJobBtn = document.getElementById('add-job-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const newJobForm = document.getElementById('new-job-form');
            const jobsTableBody = document.getElementById('jobs-table-body');
            const mainMessageContainer = document.getElementById('main-message-container');

            const editJobModal = document.getElementById('edit-job-modal');
            const editJobForm = document.getElementById('edit-job-form');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const viewApplicantsModal = document.getElementById('view-applicants-modal');
            
            let allJobsData = []; 

            // --- FIX: RESTORING THE HELPER FUNCTIONS ---
            const displayMainMessage = (message, type = 'success') => {
                const color = type === 'success' ? 'green' : 'red';
                mainMessageContainer.innerHTML = `<div class="p-4 mb-4 text-sm text-${color}-700 bg-${color}-100 rounded-lg" role="alert">${message}</div>`;
                setTimeout(() => { mainMessageContainer.innerHTML = ''; }, 3000);
            };
            
            const openModal = (modal) => {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                lucide.createIcons();
            };

            const closeModal = (modal) => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };

            const loadAndRenderApplicants = (jobId) => {
                const applicantsBody = document.getElementById('view-applicants-body');
                applicantsBody.innerHTML = '<p>Loading applicants...</p>';
                fetch('api/manage_jobs_handler.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_applicants', job_id: jobId })
                })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        applicantsBody.innerHTML = '';
                        if (result.data.length === 0) {
                            applicantsBody.innerHTML = '<p>No one has applied for this job yet.</p>';
                        } else {
                            const list = document.createElement('ul');
                            list.className = 'space-y-3';
                            result.data.forEach(applicant => {
                                list.innerHTML += `<li class="p-2 border-b"><p class="font-semibold">${applicant.name}</p><p class="text-sm text-gray-500">${applicant.email}</p></li>`;
                            });
                            applicantsBody.appendChild(list);
                        }
                    } else {
                        applicantsBody.innerHTML = `<p class="text-red-500">${result.error}</p>`;
                    }
                });
            };

             document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    closeModal(editJobModal);
                    closeModal(viewApplicantsModal);
                });
            });

            const fetchJobs = () => {
                fetch('api/manage_jobs_handler.php?t=' + new Date().getTime())
                    .then(response => {
                         if (!response.ok) {
                             if (response.status === 401) window.location.href = 'organization_login.html';
                             throw new Error('Network response was not ok');
                         }
                         return response.json();
                    })
                    .then(jobs => {
                        allJobsData = jobs; 
                        jobsTableBody.innerHTML = '';
                        if (jobs.length === 0) {
                            jobsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">You have not posted any jobs yet.</td></tr>';
                        } else {
                            jobs.forEach(job => {
                                const applicantCellHtml = job.applicant_count > 0 
                                    ? `<div class="flex items-center space-x-2"><span>${job.applicant_count}</span><button class="text-green-600 hover:text-green-900 view-applicants-btn text-xs font-semibold hover:underline" data-job-id="${job.id}">(View)</button></div>`
                                    : `<span>${job.applicant_count}</span>`;
                                
                                const row = `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${job.title}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.location}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.formatted_date}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${applicantCellHtml}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button class="text-indigo-600 hover:text-indigo-900 edit-btn" data-job-id="${job.id}">Edit</button>
                                            <button class="text-red-600 hover:text-red-900 ml-4 delete-btn" data-job-id="${job.id}">Delete</button>
                                        </td>
                                    </tr>`;
                                jobsTableBody.innerHTML += row;
                            });
                        }
                    })
            };

            addJobBtn.addEventListener('click', () => { addJobForm.style.display = 'block'; });
            cancelBtn.addEventListener('click', () => { addJobForm.style.display = 'none'; newJobForm.reset(); });

            newJobForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(newJobForm);
                const data = {
                    action: 'create',
                    jobTitle: formData.get('jobTitle'),
                    location: formData.get('location'),
                    description: formData.get('description'),
                    isRemote: formData.get('isRemote') === 'on',
                    job_type: formData.get('job_type'),
                    salary_range: formData.get('salary_range'),
                    experience_level: formData.get('experience_level'),
                    requirements: formData.get('requirements')
                };

                fetch('api/manage_jobs_handler.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        displayMainMessage('Job posted successfully!');
                        addJobForm.style.display = 'none';
                        newJobForm.reset();
                        fetchJobs(); 
                    } else {
                        document.getElementById('form-message').innerHTML = `<p class="text-red-600">${result.error}</p>`;
                    }
                });
            });
            
            jobsTableBody.addEventListener('click', (e) => {
                const target = e.target;
                const jobId = e.target.closest('[data-job-id]')?.dataset.jobId;
                if (!jobId) return;

                if (target.classList.contains('edit-btn')) {
                    const jobToEdit = allJobsData.find(job => job.id == jobId);
                    if (jobToEdit) {
                        document.getElementById('editJobId').value = jobToEdit.id;
                        document.getElementById('editJobTitle').value = jobToEdit.title;
                        document.getElementById('editLocation').value = jobToEdit.location;
                        document.getElementById('editDescription').value = jobToEdit.description;
                        document.getElementById('editIsRemote').checked = (jobToEdit.is_remote == 1);
                        document.getElementById('edit_job_type').value = jobToEdit.job_type;
                        document.getElementById('edit_experience_level').value = jobToEdit.experience_level;
                        document.getElementById('edit_salary_range').value = jobToEdit.salary_range;
                        document.getElementById('edit_requirements').value = jobToEdit.requirements;
                        openModal(editJobModal);
                    }
                }

                if (target.classList.contains('delete-btn')) {
                    if (confirm('Are you sure you want to delete this job posting?')) {
                        fetch('api/manage_jobs_handler.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'delete', id: jobId }) })
                            .then(res => res.json())
                            .then(result => {
                                displayMainMessage(result.message, result.success ? 'success' : 'error');
                                if (result.success) fetchJobs();
                            });
                    }
                }
                
                if (target.classList.contains('view-applicants-btn')) {
                    const job = allJobsData.find(j => j.id == jobId);
                    document.getElementById('view-applicants-title').innerText = `Applicants for: ${job.title}`;
                    loadAndRenderApplicants(jobId);
                    openModal(viewApplicantsModal);
                }
            });
            
            cancelEditBtn.addEventListener('click', () => { closeModal(editJobModal); });
            
            editJobForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(editJobForm);
                const data = {
                    action: 'update',
                    id: formData.get('id'),
                    jobTitle: formData.get('jobTitle'),
                    location: formData.get('location'),
                    description: formData.get('description'),
                    isRemote: formData.get('isRemote') === 'on',
                    job_type: formData.get('job_type'),
                    salary_range: formData.get('salary_range'),
                    experience_level: formData.get('experience_level'),
                    requirements: formData.get('requirements')
                };

                fetch('api/manage_jobs_handler.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        displayMainMessage('Job updated successfully!');
                        closeModal(editJobModal);
                        fetchJobs();
                    } else {
                         document.getElementById('edit-form-message').innerHTML = `<p class="text-red-600">${result.error}</p>`;
                    }
                });
            });

            fetchJobs();
        });
    </script>
</body>
</html>

